# Stresstest-kit

Stresstest-kit - инструмент для тестирования собственной сети блокчейна Ethereum. Инструмент позволяет
отрегулировать параметры сети  с помощью тестов, позволяет деплоить контракты, отправлять 
транзакции, получать данные о пользователях, блоках, транзакциях.

Для того, чтобы начать работу, необходимо инициализировать контроллер:

    tests = TestController(address, config, accounts)
    
address - адрес вашей сети (пример - localhost:8545) ;
config - функция-конфигурация тестируемой сети, например:

    def localhost_config(binder):
        binder.bind_to_constructor(ParityEthJsoRpc, lambda: ParityEthJsonRpc("localhost:8545"))
         
новую конфигурацию рекомендуется создавать в файле conf.py;

accounts - список аккаунтов, состоящий из пар адрес-приватный ключ.

Логика работы подразумевает добавление различных команд в созданный контроллер и последующий запуск:

    tests.add_test("command", (params, ), <flows>)

command - название команды, добавляемой в список исполняемых задач контроллера. Некоторые команды могут быть 
запущены многопоточно 

На данный момент существуют команды:

многопотоковые:
* test_heavy
* test_expensive
* test_same

без многопоточности:
* balance
* deploy
* accounts
* get_trans
* send_trans
* send_eth
* unlock
* unlocks
* private
* privates

params - список параметров, которая принимает команда. Обязательно должен быть в виде кортежа: (аргумент1, ) или (аргумент1, аргумент2, ... , аргументN);

flows - необязательный параметр. Нужен для команд, использующих многопоточность. Число потоков не может быть больше числа аккаунтов.

Для запуска всех команд:

    tests.start_tests()


###Деплой контракта

Для деплоя контракта у вас должен быть файл *.sol, в котором будет ваш контракт:
    
    tests.add_test("deploy", (yourSolFile.sol, priv_key))
    
sol-файл должен находиться в /contracts/;

priv_key - приватный ключ аккаунта, с которого будет осуществлён деплой.
После выполнения генерируется abi-файл и сохраняется в /contracts/abi/ под именем контракта


###Вызов метода контракта:
   
    tests.add_test("send_trans", (priv_key, contract_address, method_name, abi_file, 
    nonce, <to>, <value>, <args>, <gasprice>))
    
priv_key - приватный ключ аккаунта;

contract_address - адрес контракте в сети. Пример деплоя контракта выше;

method_name - имя метода контракте;

abi_file - имя abi-файла контракта, генерируется при деплое;

nonce - номер следующей отправленной транзакции;

to - необязательный параметр, адрес получателя

value - необязательный параметр, количество отправляемого эфира;

args - необязательный параметр, аргументы, которые принимает метод;

gasprice - необязательный параметр, цена за единицу потраченного газа в транзакции.


###Тесты

На данный момент для регулирования параметров сети существует тесты: 
- Тест с большим потоком транзакций: 

На вход подаётся список аккаунтов и происходит отправка друг другу
эфира (аккаунты должны иметь некоторое количество эфира в кошельке):
    
    
    tests.add_test("test_many", (20,), flows=10)
    
20 - число секунд, в течение которых будет выполняться тест.
10 - число запускаемых потоков - чем больше это число, тем выше нагрузка на сеть (не может быть больше числа аккаунтов);

- Тест с "тяжёлыми" транзакциями: 

Представляет собой вызов методов контракта, который будет
требовать для выполнения 70-90% от общего числа газа в блоке. Для примера, можно вызвать метод
cycle в контракте:


    pragma solidity ^0.4.24;
    
    contract test {
        function empty () public view {
            
        }
    
        function cycle (uint a) public view returns (bytes, uint, uint, uint256, uint) {
            uint256 startGas = gasleft();
    
            for (uint i = 0; i < 250000; i++)
            {
                sha3("100");
            }
            uint gasUsed = startGas - gasleft();
            return (msg.data, block.gaslimit, block.number, gasUsed, gasleft());
        }
    }

Общий вид:

    tests.add_test("test_heavy", (sec, contract_address, method_name, abi_dile), <flows>)

sec - время в секундах выполнения теста;
    
contract_address - адрес контракте в сети. Пример деплоя контракта выше;

method_name - имя метода контракте;

abi_file - имя abi-файла контракта, генерируется при деплое;

flows - необязательный параметр, число потоков

Пример:

    tests.add_test("test_heavy", (20, "0xa981c1D103F000387fbd025ccc403EA58353EF48", "empty", "test.abi"), flows=10)

- Тест с дорогими транзакциями:

Представляет собой вызов методов контракта, в параметрах которого(вызова) будет высокая цена за единицу газа
Для примера, можно вызвать метод empty в контракте выше:



###Зарегистрировать новый аккаунт в тестируемой сети:

* install geth - sudo apt-get install geth
* geth account new - вводится мнемоника с подтверждением
* скопировать сгенерированный файл из home/.ethereum/keystore/ в папку проекта: /accounts/
* добавить в список команд:
    
    
    tests.add_test("private", (account_file, passphrase)) # либо
    tests.add_test("privates", (passphrase, )) # если создано много аккаунтов с одной мнемоникой
    
passphrase - мнемоника, введённая в шаге выше. Команда вернёт приватный ключ.

    
